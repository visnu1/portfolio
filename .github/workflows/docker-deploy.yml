name: Portfolio CI/CD

on:
    push:
        branches:
            - main

jobs:
    projectbuild:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: '16'

            - name: Install dependencies
              run: npm ci

            - name: Build project
              run: npm run build

    dockerbuild:
        runs-on: ubuntu-latest
        needs: projectbuild # Wait for projectbuild

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Log in to DockerHub
              uses: docker/login-action@v2
              with:
                  username: ${{ secrets.USER }}
                  password: ${{ secrets.PWD }}

            - name: Build Docker image
              run: docker build -t srivisnu/portfolio:${{ github.sha }} -t srivisnu/portfolio:latest .

            - name: Push Docker image
              run: |
                docker push srivisnu/portfolio:${{ github.sha }}
                docker push srivisnu/portfolio:latest

    deploy:
        runs-on: ubuntu-latest
        needs: dockerbuild # Wait

        steps:
            - name: Deploy to the server
              uses: appleboy/ssh-action@v0.1.7
              with:
                host: ${{ secrets.HOST }}
                username: ${{ secrets.SERVER_USER }}
                key: ${{ secrets.SERVER_PRIVATE_KEY }}
                script: |
                    docker stop portfolio || true
                    docker rm portfolio || true
                    docker pull srivisnu/portfolio:latest
                    docker run -d --name portfolio --restart always -p 8081:8081 srivisnu/portfolio:latest
